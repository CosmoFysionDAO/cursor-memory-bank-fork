# AGENT Command — Security Agent Mode

Команда **утилиты** (вне основного workflow `/van` → … → `/archive`). Управление режимом безопасности агента: инициализация, аудит, обновление правил, быстрая проверка.

**Программатический вызов:** для CI/pre-commit можно запустить `node .cursor/commands/agent.js <subcommand>` (см. раздел Usage).

## Аргументы (подкоманды)

Обрабатываются следующие подкоманды: **`init`**, **`audit`**, **`update-rules`**, **`check`**.

Если пользователь ввёл `/agent` без аргумента или с неизвестным — вывести краткую справку по подкомандам и предложить выбрать одну.

---

## Memory Bank Integration

Читает:
- `memory-bank/activeContext.md` — текущий контекст (для audit/check).

Обновляет (в зависимости от подкоманды):
- `memory-bank/activeContext.md` — при init (запись об инициализации); при audit (если найдены критические проблемы — добавить в «Текущий фокус»).
- `memory-bank/progress.md` — после audit и при необходимости после других действий.
- `memory-bank/decisionLog.md` — при update-rules (описание изменённых правил).
- `memory-bank/audit/` — директория для отчётов аудита (создаётся при init/audit при необходимости).

---

## Подкоманда: `/agent init`

1. **Создать `AGENT.md` в корне проекта** (если ещё нет):
   - Использовать шаблон `.cursor/templates/agent_template.md`.
   - Заполнить: версия, цель (режим безопасности), правила поведения агента, раздел для отчётов аудита (пустой или с пометкой «заполняется после /agent audit»).

2. **Создать `.agentignore` в корне** (если ещё нет):
   - Предустановленные шаблоны (из `.cursor/templates/agentignore_defaults.md`, только строки-паттерны, без комментариев):
     ```
     node_modules/
     .git/
     secrets.yaml
     *.log
     .env
     ```
   - Добавить при необходимости: `secrets.yml`, `.env.*`, `**/credentials.json`, `**/secrets/**`, `**/*.key`, `**/*.pem` и т.п. по тому же принципу, что и в `.cursor/templates/cursorignore_security_defaults.md`.

3. **Сканирование на потенциальные секреты:**
   - Просканировать проект (файлы, не исключённые по `.agentignore` и `.gitignore`) по сигнатурам (регулярные выражения), например:
     - `api[_-]?key\s*=\s*['\"][A-Za-z0-9_]{16,}['\"]`
     - `password\s*=\s*['\"][^'\"]{8,}['\"]`
     - `secret\s*=\s*['\"][^'\"]+['\"]`
     - `(aws_access_key|aws_secret|token)\s*[=:]\s*['\"]?[A-Za-z0-9/+=]{20,}`
   - Найденные файлы **предложить** добавить в `.agentignore` (вывести список и спросить подтверждение пользователя; при подтверждении — добавить паттерны или пути).

4. **Обновить `memory-bank/activeContext.md`:**
   - Добавить запись о инициализации agent mode (дата, что сделано: созданы AGENT.md, .agentignore, проведено сканирование).

5. **Создать директорию `memory-bank/audit/`** если её ещё нет.

---

## Подкоманда: `/agent audit`

Глубокий анализ безопасности проекта.

1. **Статический анализ кода:**
   - Поиск уязвимых паттернов (например, `exec.Command`/`exec.CommandContext` с интерполяцией строки без санитизации, hardcoded secrets по тем же regex, что и в init).
   - Указать файлы и номера строк (или диапазоны), уровень критичности (high / medium / low).

2. **Проверка зависимостей:**
   - Анализ `go.mod`, `package.json`, `requirements.txt`, `Cargo.toml`, `pom.xml` и т.д.
   - По возможности проверить уязвимости через публичные API (например, OSV: https://osv.dev/api/v1/query). При отсутствии доступа к сети — вывести предупреждение и пропустить этот блок.

3. **Проверка конфигураций:**
   - Dockerfile: запуск от root, отсутствие HEALTHCHECK, использование устаревших образов (e.g. latest без пина), открытые порты.
   - docker-compose.yml: те же аспекты, плюс секреты в plain text.
   - Terraform (.tf): секреты в plain text, небезопасные настройки.

4. **Сетевые настройки (если есть):**
   - nginx.conf, apache.conf и т.п. — открытые порты, слабые настройки (например, отключённый server_tokens, небезопасные директивы).

5. **Результаты сохранить:**
   - В **`AGENT.md`** в структурированном виде:
     - Дата проверки.
     - Список найденных проблем (файл, строка, уровень, рекомендация).
   - Создать копию отчёта в **`memory-bank/audit/audit-{timestamp}.md`** (например, `audit-20250221-143022.md`) с тем же содержимым.

6. **Обновить `memory-bank/progress.md`:** добавить запись о проведённом аудите (дата, краткое перечисление категорий проверок и количество найденных проблем).

7. При наличии критических (high) проблем — обновить **`memory-bank/activeContext.md`**: добавить в раздел «Текущий фокус» пункт о необходимости исправления этих проблем.

---

## Подкоманда: `/agent update-rules`

1. Проанализировать последний отчёт аудита (из раздела аудита в `AGENT.md` или последний файл в `memory-bank/audit/` по имени/дате).

2. Выявить повторяющиеся проблемы (одинаковый тип уязвимости в разных файлах).

3. Сгенерировать или обновить правила в `.cursor/rules/`:
   - Формат: markdown с YAML frontmatter, понятный Cursor (например, `.mdc`).
   - Пример frontmatter:
     ```yaml
     ---
     title: "Avoid hardcoded secrets"
     description: "Detects potential hardcoded API keys or passwords."
     patterns:
       - "api[_-]?key\\s*=\\s*['\"][A-Za-z0-9_]{16,}['\"]"
       - "password\\s*=\\s*['\"][^'\"]{8,}['\"]"
     severity: "high"
     ---
     ```
   - Если правило с таким названием уже есть — обновить (добавить паттерны или описание). Если нет — создать новый файл (например, `security-hardcoded-secrets.mdc` или в существующем `security.mdc` добавить секцию).

4. **Обновить `memory-bank/decisionLog.md`:** добавить запись с описанием внесённых изменений в правила (дата, какие правила созданы/обновлены и почему).

---

## Подкоманда: `/agent check`

Быстрая проверка (без глубокого анализа зависимостей и конфигураций).

1. Выполнить только:
   - Статический анализ кода на уязвимые паттерны (как в audit, но без разбора Docker/Terraform/nginx и без вызова внешних API зависимостей).
   - Поиск потенциальных секретов по тем же regex, что в init.

2. Вывести предупреждения по найденным проблемам (файл, строка, краткое описание).

3. **Exit code:** возвращать 1 при наличии проблем с уровнем **high** (для использования в pre-commit или CI). Иначе 0.

При запуске через Cursor (чат) — вывести отчёт в ответ; при запуске через `node .cursor/commands/agent.js check` — вывод в stdout/stderr и процесс завершать с кодом 0 или 1.

---

## Интеграция с Memory Bank (сводка)

- **init:** создаёт/обновляет AGENT.md, .agentignore; создаёт `memory-bank/audit/`; обновляет `activeContext.md`.
- **audit:** пишет отчёт в AGENT.md и `memory-bank/audit/audit-{timestamp}.md`; обновляет `progress.md` и при необходимости `activeContext.md`.
- **update-rules:** обновляет `.cursor/rules/` и `memory-bank/decisionLog.md`.
- **check:** только вывод и exit code; при необходимости можно добавить краткую запись в `progress.md` (опционально).

---

## Usage

```
/agent
/agent init
/agent audit
/agent update-rules
/agent check
```

**Программатически (Node.js):**
```bash
node .cursor/commands/agent.js init
node .cursor/commands/agent.js audit
node .cursor/commands/agent.js update-rules
node .cursor/commands/agent.js check
```

---

## Next steps

После `init` — при необходимости выполнить `audit`. После `audit` — при необходимости выполнить `update-rules`. Команду `check` можно вызывать в любой момент (в том числе из pre-commit или перед `/build`).
